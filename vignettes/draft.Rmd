---
title: "A Replication of `Benchmarks as Limits to Arbitrage'"
author: "David Kane"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, echo = FALSE, message = FALSE, warning = FALSE)
library(dplyr)
library(ggplot2)
library(RcppRoll)
library(ws.data)
library(baker1)
```


# Introduction

"Benchmarks as Limits to Arbitrage: Understanding the Low Volatility Anomaly" by Baker, Bradley and Wurgler (2011)^[http://people.stern.nyu.edu/jwurgler/papers/faj-benchmarks.pdf] is an important paper in the literature on low volatility investing. I replicate the main results of this paper using data for large capitalization US stocks from 1998 through 2007.

# Literature Review

# Data

Let's take a look at a summary of the data.

```{r}
## Gathering data takes long enough to be annoying. Is there someway to just do
## this once?

x <- gather_data()

## Now that we have the key data, there are two main tasks. First, we need to
## know the trailing one year volatility for each stock on the last day of the
## month. Second, we need to know each stock's monthly return.

summary(x)
```

Calculate the trailing 252-day standard deviation of returns, for the last trade date of each month. Summary of that data:

```{r, calculate_sd}
## Ought to do some error checking to see if this is really doing what I want.

x <- x %>% group_by(symbol) %>% 
        mutate(sd.252 = roll_sdr(tret, 250, fill = NA))

## Maybe show some graphics? 

## We really only need this data for the last day of the month, so, we can 
## filter out the rest as here. Keep in mind that this is the last trade day of
## the month, not always the last day.

monthly.sd <- x %>% group_by(month) %>% filter(min_rank(desc(date)) == 1)

## Need to examine this data. Deal with outliers and NA.

summary(monthly.sd)
```

Calculate monthly returns for each stock.

```{r}
## Are we dealing with outliers and NA in a reasonable fashion? Should we be 
## summing returns or compounding them? What sort of test cases should we add?

monthly.ret <- x %>% group_by(month, symbol) %>% summarize(ret.0.1.m = sum(tret))

## Note the annoying ordering of the data and how hard it is to fix, given that
## we don't have date around anymore.
```

Calculate summary statistics for the monthly data that we will use to plot portfolio returns.

```{r}
## Bring the sd.252 and ret.0.1.m data together. Dealing with merging dates
## correctly is always harder than it seems.

## Merge the monthly.sd (which is data of the last trade date of month M) with
## monthly.ret (which is data for the return of each stock over the course of
## month M + 1). Note adding + 10 to date instead of just 1. Why?

monthly.sd <- mutate(monthly.sd, 
                     month.plus.1 = paste(lubridate::month(date + 10, TRUE, TRUE), 
                                          lubridate::year(date + 10), sep = "-"))

all <- left_join(select(monthly.sd, - month), monthly.ret, 
                 by = c("symbol", c("month.plus.1" = "month")))

## Is having a variable called "month" creating all sorts of problems? I can't
## seem to just -month select it. Hmmm

all <-  filter(all, ! is.na(sd.252))  %>% 
        group_by(month.plus.1) %>% 
        mutate(sd.class = ntile(sd.252, n = 5)) %>% 
        select(month.plus.1, sd.class, ret.0.1.m)

summary(all)
```

Create the plots from Baker et al.

```{r}

```




# Replication

# Extension

# Conclusion
